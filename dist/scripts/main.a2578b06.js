function removeRouting(){$(".leaflet-routing-container").length&&map.removeControl(routeControl)}function addRouting(){var a=this.getLatLng().lat,b=this.getLatLng().lng;console.log(a,b),routeControl=L.Routing.control({waypoints:[L.latLng(lat,lng),L.latLng(a,b)],lineOptions:{styles:[{color:"white",opacity:.8,weight:8},{color:"#2676C6",opacity:1,weight:4}]},routeWhileDragging:!1,createMarker:function(){return!1},router:L.Routing.valhalla("valhalla-obkccAI","pedestrian"),formatter:new L.Routing.Valhalla.Formatter}).addTo(map),routeControl.RoutingErrorEvent}function addOnClick(a){lat=this.getLatLng().lat,lng=this.getLatLng().lng,console.log(lat,lng),removeRouting(a),map.hasLayer(bar)&&map.removeLayer(bar),$.getJSON("https://darkvengers.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM liquor ORDER BY the_geom <-> ST_SetSRID(ST_MakePoint("+lng+","+lat+"), 4326) LIMIT 20",function(a){bar=L.geoJson(a,{onEachFeature:function(a,b){b.bindPopup(""+a.properties.bus_prof_n),b.on("click",removeRouting),b.on("click",addRouting)},pointToLayer:function(a,b){return L.marker(b,{icon:L.AwesomeMarkers.icon({icon:"fa-beer fa-2x",markerColor:"orange",prefix:"fa"})})}}).addTo(map),map.fitBounds(bar.getBounds())})}!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a,b,c){function d(a){return a>=200&&300>a||304===a}function e(){void 0===h.status||d(h.status)?b.call(h,null,h):b.call(h,h,null)}var f=!1;if("undefined"==typeof window.XMLHttpRequest)return b(Error("Browser not supported"));if("undefined"==typeof c){var g=a.match(/^\s*https?:\/\/[^\/]*/);c=g&&g[0]!==location.protocol+"//"+location.domain+(location.port?":"+location.port:"")}var h=new window.XMLHttpRequest;if(c&&!("withCredentials"in h)){h=new window.XDomainRequest;var i=b;b=function(){if(f)i.apply(this,arguments);else{var a=this,b=arguments;setTimeout(function(){i.apply(a,b)},0)}}}return"onload"in h?h.onload=e:h.onreadystatechange=function(){4===h.readyState&&e()},h.onerror=function(a){b.call(this,a||!0,null),b=function(){}},h.onprogress=function(){},h.ontimeout=function(a){b.call(this,a,null),b=function(){}},h.onabort=function(a){b.call(this,a,null),b=function(){}},h.open("GET",a,!0),h.send(null),f=!0,h}"undefined"!=typeof b&&(b.exports=c)},{}],2:[function(a,b){function c(a,b){a=Math.round(a*b),a<<=1,0>a&&(a=~a);for(var c="";a>=32;)c+=String.fromCharCode((32|31&a)+63),a>>=5;return c+=String.fromCharCode(a+63)}var d={};d.decode=function(a,b){for(var c,d,e=0,f=0,g=0,h=[],i=0,j=0,k=null,l=Math.pow(10,b||5);e<a.length;){k=null,i=0,j=0;do k=a.charCodeAt(e++)-63,j|=(31&k)<<i,i+=5;while(k>=32);c=1&j?~(j>>1):j>>1,i=j=0;do k=a.charCodeAt(e++)-63,j|=(31&k)<<i,i+=5;while(k>=32);d=1&j?~(j>>1):j>>1,f+=c,g+=d,h.push([f/l,g/l])}return h},d.encode=function(a,b){if(!a.length)return"";for(var d=Math.pow(10,b||5),e=c(a[0][0],d)+c(a[0][1],d),f=1;f<a.length;f++){var g=a[f],h=a[f-1];e+=c(g[0]-h[0],d),e+=c(g[1]-h[1],d)}return e},void 0!==typeof b&&(b.exports=d)},{}],3:[function(){(function(a){!function(){"use strict";var b="undefined"!=typeof window?window.L:"undefined"!=typeof a?a.L:null;b.Routing=b.Routing||{},b.Routing.Valhalla.Formatter=b.Class.extend({options:{units:"metric",unitNames:{meters:"m",kilometers:"km",yards:"yd",miles:"mi",hours:"h",minutes:"mÃ­n",seconds:"s"},language:"en",roundingSensitivity:1,distanceTemplate:"{value} {unit}"},initialize:function(a){b.setOptions(this,a)},formatDistance:function(a){var c,d,e=this.options.unitNames;return"imperial"===this.options.units?(a=1e3*a,a/=1.609344,d=a>=1e3?{value:this._round(a)/1e3,unit:e.miles}:{value:this._round(a/1.76),unit:e.yards}):(c=a,d={value:c>=1?c:1e3*c,unit:c>=1?e.kilometers:e.meters}),b.Util.template(this.options.distanceTemplate,d)},_round:function(a){var b=Math.pow(10,(Math.floor(a/this.options.roundingSensitivity)+"").length-1),c=Math.floor(a/b),d=c>5?b:b/2;return Math.round(a/d)*d},formatTime:function(a){return a>86400?Math.round(a/3600)+" h":a>3600?Math.floor(a/3600)+" h "+Math.round(a%3600/60)+" min":a>300?Math.round(a/60)+" min":a>60?Math.floor(a/60)+" min"+(a%60!==0?" "+a%60+" s":""):a+" s"},formatInstruction:function(a){return a.instruction},getIconName:function(a){switch(a.type){case 1:return"kStart";case 2:return"kStartRight";case 3:return"kStartLeft";case 4:return"kDestination";case 5:return"kDestinationRight";case 6:return"kDestinationLeft";case 7:return"kBecomes";case 8:return"kContinue";case 9:return"kSlightRight";case 10:return"kRight";case 11:return"kSharpRight";case 12:return"kUturnRight";case 13:return"kUturnLeft";case 14:return"kSharpLeft";case 15:return"kLeft";case 16:return"kSlightLeft";case 17:return"kRampStraight";case 18:return"kRampRight";case 19:return"kRampLeft";case 20:return"kExitRight";case 21:return"kExitLeft";case 22:return"kStayStraight";case 23:return"kStayRight";case 24:return"kStayLeft";case 25:return"kMerge";case 26:return"kRoundaboutEnter";case 27:return"kRoundaboutExit";case 28:return"kFerryEnter";case 29:return"kFerryExit"}},_getInstructionTemplate:function(a){return a.instruction+" "+a.length}})}()}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],4:[function(a,b){(function(c){!function(){"use strict";var d="undefined"!=typeof window?window.L:"undefined"!=typeof c?c.L:null,e=a("corslite"),f=a("polyline");d.Routing=d.Routing||{},d.Routing.Valhalla=d.Class.extend({initialize:function(a,b,c,e){d.Util.setOptions(this,e||{serviceUrl:"//valhalla.mapzen.com/",timeout:3e4,transitmode:"auto"}),this._accessToken=a,this._transitmode=b,this._costingOptions=c,this._hints={locations:{}}},route:function(a,b,c,f){var g,h,i,j,k=!1,l=[];for(f=f||{},g=this.buildRouteUrl(a,f),h=setTimeout(function(){k=!0,b.call(c||b,{status:-1,message:"OSRM request timed out."})},this.options.timeout),j=0;j<a.length;j++)i=a[j],l.push({latLng:i.latLng,name:i.name||"",options:i.options||{}});return e(g,d.bind(function(a,d){var e;clearTimeout(h),k||(a?(console.log("Error : "+a.response),b.call(c||b,{status:a.status,message:a.response})):(e=JSON.parse(d.responseText),this._routeDone(e,l,b,c)))},this),!0),this},_routeDone:function(a,b,c,d){var e,g,h,i;if(d=d||c,0!==a.trip.status)return void c.call(d,{status:a.status,message:a.status_message});for(var j=[],e=[],k=0,i=0;i<a.trip.legs.length;i++){for(var l=f.decode(a.trip.legs[i].shape,6),m=0;m<l.length;m++)e.push(l[m]);for(var n=0;n<a.trip.legs[i].maneuvers.length;n++){var o=a.trip.legs[i].maneuvers[n];o.distance=a.trip.legs[i].maneuvers[n].length,o.index=k+a.trip.legs[i].maneuvers[n].begin_shape_index,j.push(o)}k+=a.trip.legs[i].maneuvers[a.trip.legs[i].maneuvers.length-1].begin_shape_index}h=this._toWaypoints(b,a.trip.locations),g=[{name:this._trimLocationKey(b[0].latLng)+" , "+this._trimLocationKey(b[1].latLng),unit:a.trip.units,transitmode:this._transitmode,coordinates:e,instructions:j,summary:a.trip.summary?this._convertSummary(a.trip.summary):[],inputWaypoints:b,waypoints:h,waypointIndices:this._clampIndices([0,a.trip.legs[0].maneuvers.length],e)}],a.hint_data&&this._saveHintData(a.hint_data,b),c.call(d,null,g)},_saveHintData:function(a,b){var c;this._hints={checksum:a.checksum,locations:{}};for(var d=a.locations.length-1;d>=0;d--)c=b[d].latLng,this._hints.locations[this._locationKey(c)]=a.locations[d]},_toWaypoints:function(a,b){var c,e=[];for(c=0;c<b.length;c++)e.push(d.Routing.waypoint(d.latLng([b[c].lat,b[c].lon]),"name",{}));return e},buildRouteUrl:function(a,b){var c,d=[],e=b.transitmode||this._transitmode,f=b.street,g=this._costingOptions;this._transitmode=e;for(var h=0;h<a.length;h++){var i;c=this._locationKey(a[h].latLng).split(","),i=0===h||h===a.length-1?{lat:parseFloat(c[0]),lon:parseFloat(c[1]),type:"break"}:{lat:parseFloat(c[0]),lon:parseFloat(c[1]),type:"through"},d.push(i)}var j=JSON.stringify({locations:d,costing:e,street:f,costing_options:g});return this.options.serviceUrl+"route?json="+j+"&api_key="+this._accessToken},_locationKey:function(a){return a.lat+","+a.lng},_trimLocationKey:function(a){var b=(a.lat,a.lng,Math.floor(1e3*a.lat)/1e3),c=Math.floor(1e3*a.lng)/1e3;return b+" , "+c},_convertSummary:function(a){return{totalDistance:a.length,totalTime:a.time}},_convertInstructions:function(a){var b,c,d,e,f=[];for(b=0;b<a.length;b++)c=a[b],d=this._drivingDirectionType(c[0]),e=c[0].split("-"),d&&f.push({type:d,distance:c[2],time:c[4],road:c[1],direction:c[6],exit:e.length>1?e[1]:void 0,index:c[3]});return f},_clampIndices:function(a,b){var c,d=b.length-1;for(c=0;c<a.length;c++)a[c]=Math.min(d,Math.max(a[c],0))}}),d.Routing.valhalla=function(a,b,c){return new d.Routing.Valhalla(a,b,c)},b.exports=d.Routing.Valhalla}()}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{corslite:1,polyline:2}]},{},[4,3]);var map=L.map("map",{zoomControl:!1}).setView([39.7398,-104.911276],11);L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'}).addTo(map);var bar=null,stations=$.getJSON("https://darkvengers.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT s.* FROM stations as s, denver as d WHERE ST_Within(s.the_geom, d.the_geom)",function(a){stations=L.geoJson(a,{onEachFeature:function(a,b){b.cartodb_id=a.properties.cartodb_id,b.bindPopup(""+a.properties.name),b.on("click",addOnClick),b.on("click",function(){infoBox.update(b.feature.properties)})},pointToLayer:function(a,b){return L.marker(b,{icon:L.AwesomeMarkers.icon({icon:"fa-subway fa-2x",markerColor:"red",prefix:"fa"})})}}).addTo(map),map.fitBounds(stations.getBounds())}),lat,lng,routeControl,stnName=void 0,infoBox=L.control({position:"topleft"});infoBox.onAdd=function(){return this._div=L.DomUtil.create("div","infoBox"),this.update(),this._div},infoBox.update=function(a){this._div.innerHTML="<h1>Ride and Drink</h1><hr><p>Click on a station to find the nearest bars.<p>"+(a?"<h1><b>"+a.name+"</b></h1>":"")},infoBox.addTo(map);